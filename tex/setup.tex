% Set up bibligraphy style
\defbibheading{bibliography}[\bibname]{\section{#1}}

% Set the bibliography source
\addbibresource{PelepsWuTian.bib}

% Set the page size.
\geometry{paper=letterpaper, margin=1in}

% Set up our preferred fonts.
\setmainfont[Ligatures={Common,TeX}]{Libertinus Serif}
\setmathfont{Libertinus Math}
\newfontfamily\FancyFont{Envision}

% Store a subtitle
\newcommand{\thesubtitle}{}
\newcommand{\subtitle}[1]{\renewcommand{\thesubtitle}{#1}}

\newpagestyle{main}{%
    \sethead{}{\MakeUppercase{\chaptertitle}}{}%
    \setfoot{}{\thepage}{}%
}

% Don't show numbers for titles, and set up formating.
\titleformat{\chapter}[display]%
    {\filcenter\normalfont\large\scshape}{\chaptertitlename\ \Numberstring{chapter}}{5pt}{\FancyFont\huge}
\titleformat{\section}{\FancyFont\large}{}{0pt}{}
\titleformat{\subsection}{\normalfont\large\bfseries\scshape}{}{0pt}{}
\titleformat{\subsubsection}[runin]{\normalfont\bfseries}{}{0pt}{}[:]
\titleformat{\paragraph}[runin]{\normalfont\itshape}{}{0pt}{}

% Reduce spacing around titles.
\titlespacing*{\section}{0pt}{2\parskip}{0.5\parskip}
\titlespacing*{\subsection}{0pt}{\parskip}{0pt}
\titlespacing*{\subsubsection}{0pt}{\parskip}{2\wordsep}
\titlespacing*{\paragraph}{0pt}{0pt}{2\wordsep}

% Increase space between table rows
\renewcommand{\arraystretch}{1.25}

% URLs should be typeset in the same font as the surrouding text.
\urlstyle{same}

% Dates are separated with -, not /
\renewcommand{\dateseparator}{-}

% A date format for Day Month Year style dates.
\newdateformat{ddmmmyyyydate}{%
    \ifshowdow\dayofweekname{\THEDAY}{\THEMONTH}{\THEYEAR}\fi
    \THEDAY{} \monthname[\THEMONTH{}] \THEYEAR{}%
}

\newcommand{\blankpage}{%
    \newpage%
    \thispagestyle{empty}%
    \mbox{}%
    \newpage%
}

\newcommand{\mychapter}[2]{%
    \newrefsection%
    \chapter{#2}\label{chapter:#2}%
}

\newcommand{\mysection}[2]{%
    \section{#2}\label{section:#1}%
}

\newcommand{\mysubsection}[2]{%
    \subsection{#2}\label{subsection:#1}%
}

\newcommand{\Val}[1]{%
    \text{#1}%
}

\newcommand{\Dots}[1]{%
    \normalfont\multido{}{#1}{â€¢}%
}

\newcommand{\Keyword}[1]{%
    \textbf{#1}%
}

\newcommand{\NoCost}{---}

\NewDocumentCommand{\Pool}{mo}{%
    \( (#1 \IfValueT{#2}{, \text{#2}}) \)%
}

\newcommand{\tldr}[1]{%
    \textbf{#1}%
}

\newcommand{\TBW}{\textit{To be written\ldots}}

\newtoggle{PossibleActive}
\global\togglefalse{PossibleActive}

\NewEnviron{Possible}{%
    \toggletrue{PossibleActive}%
    \color{gray}%
    \BODY%
}

\makeatletter
\define@key{MeritKeys}{Description}{\def\MeritDescription{#1}}
\define@key{MeritKeys}{Keywords}{\def\MeritKeywords{#1}}
\define@key{MeritKeys}{Rating}{\def\MeritRating{#1}}
\define@key{MeritKeys}{Reference}{\def\MeritReference{#1}}
\makeatother

\newcommand{\Merit}[3]{%
    \setkeys{MeritKeys}{%
        Description=,%
        Keywords=,%
        Reference=,%
        #2}%
    \section{#1}\label{merit:#3}%
    \ifdefempty{\MeritDescription}{}{%
        \vspace*{-0.25\parskip}%
        \section*{(\MeritDescription)}%
    }%
    \textbf{\MeritRating}%
    \ifdefempty{\MeritKeywords}{}{%
        \\* \textbf{Keywords:} \MeritKeywords%
    }%
    \ifdefempty{\MeritReference}{}{%
        \\* \textbf{Reference:} \MeritReference%
    }%
}

\makeatletter
\define@key{ArtifactKeys}{Attunement}{\def\ArtifactAttunement{#1}}
\define@key{ArtifactKeys}{Type}{\def\ArtifactType{#1}}
\define@key{ArtifactKeys}{Tags}{\def\ArtifactTags{#1}}
\define@key{ArtifactKeys}{Hearthstone Slots}{\def\ArtifactHearthstoneSlots{#1}}
\define@key{ArtifactKeys}{Reference}{\def\ArtifactReference{#1}}
\makeatother

\newcommand{\Artifact}[1]{%
    \setkeys{ArtifactKeys}{%
        Tags=,%
        Hearthstone Slots=,%
        Reference=,%
        #1}%
    \textbf{Attunement:} \ArtifactAttunement%
    \\* \textbf{Type:} \ArtifactType%
    \ifdefempty{\ArtifactTags}{}{%
        \\* \textbf{Tags:} \ArtifactTags%
    }%
    \ifdefempty{\ArtifactHearthstoneSlots}{}{%
        \\* \textbf{Hearthstone Slot(s):} \ArtifactHearthstoneSlots%
    }%
    \ifdefempty{\ArtifactReference}{}{%
        \\* \textbf{Reference:} \ArtifactReference%
    }%
}

\newcommand{\CharmList}{}

\newcommand{\CharmSection}[2]{%
    \mysection{#1}{#2}%
    \CharmGroup{section:#1}%
}

\newcommand{\CharmGroup}[1]{%
    \ifdefempty{\CharmList}{}{%
        \gappto\CharmList{%
            \\%
        }%
    }%
    \gappto\CharmList{%
        \multicolumn{5}{l}{%
            \textbf{\nameref{#1}}%
        } \\%
    }%
}

\makeatletter
\define@key{CharmKeys}{Cost}{\def\CharmCost{#1}}
\define@key{CharmKeys}{Duration}{\def\CharmDuration{#1}}
\define@key{CharmKeys}{Keywords}{\def\CharmKeywords{#1}}
\define@key{CharmKeys}{Mins}{\def\CharmMins{#1}}
\define@key{CharmKeys}{Prerequisites}{\def\CharmPrerequisites{#1}}
\define@key{CharmKeys}{Type}{\def\CharmType{#1}}
\define@key{CharmKeys}{Reference}{\def\CharmReference{#1}}
\makeatother

\newcommand{\Charm}[3]{%
    \setkeys{CharmKeys}{%
        Cost=\NoCost,%
        Keywords=,%
        Mins=None,%
        Prerequisites=,%
        Reference=,%
        #2}%
    \subsection{#1}\label{charm:#3}%
    \textbf{Cost:} \CharmCost; \textbf{Mins:} \CharmMins%
    \\* \textbf{Type:} \CharmType%
    \ifdefempty{\CharmKeywords}{}{%
        \\* \textbf{Keywords:} \CharmKeywords%
    }%
    \\* \textbf{Duration:} \CharmDuration%
    \ifdefempty{\CharmPrerequisites}{}{%
        \\* \textbf{Prerequisite Charms:} \CharmPrerequisites%
    }%
    \ifdefempty{\CharmReference}{}{%
        \\* \textbf{Reference:} \CharmReference%
    }%
    \iftoggle{PossibleActive}{}{%
        \gappto\CharmList{%
            \nameref{charm:#3} &%
        }%
        \xappto\CharmList{%
            \expandonce{\CharmCost} &%
            \expandonce{\CharmType} &%
            \expandonce{\CharmDuration} &%
        }%
        \gappto\CharmList{%
            \pageref{charm:#3} \\%
        }%
    }%
}

\newcommand{\ClearCharmList}{%
    \renewcommand{\CharmList}{}%
}

\newcommand{\PrintCharmList}{%
    \begin{longtabu} to \linewidth {lX[L]X[L]X[L]r}%
        \textbf{Name} &%
        \textbf{Cost} &%
        \textbf{Type} &%
        \textbf{Duration} &%
        \textbf{Page} \\%
        \hline%
        \CharmList%
    \end{longtabu}%
    \ClearCharmList%
}

% vim: filetype=tex: textwidth=79:

