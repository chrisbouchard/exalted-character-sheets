% Set up bibligraphy style
\defbibheading{bibliography}[\bibname]{\section{#1}}

% Set the bibliography source
\addbibresource{PelepsWuTian.bib}

% Set the page size.
\geometry{paper=letterpaper, margin=1in}

% Set up our preferred fonts.
\setmainfont[Ligatures={Common,TeX}]{Libertinus Serif}
\setmathfont{Libertinus Math}
\newfontfamily\FancyFont{Envision}

% Store a subtitle
\newcommand{\thesubtitle}{}
\newcommand{\subtitle}[1]{\renewcommand{\thesubtitle}{#1}}

\newpagestyle{main}{%
    \sethead{}{\MakeUppercase{\chaptertitle}}{}%
    \setfoot{}{\thepage}{}%
}

% Don't show numbers for titles, and set up formating.
\titleformat{\chapter}[display]%
    {\filcenter\normalfont\large\scshape}{\chaptertitlename\ \Numberstring{chapter}}{5pt}{\FancyFont\huge}
\titleformat{\section}{\FancyFont\large}{}{0pt}{}
\titleformat{\subsection}{\normalfont\large\bfseries\scshape}{}{0pt}{}
\titleformat{\subsubsection}[runin]{\normalfont\bfseries}{}{0pt}{}[:]
\titleformat{\paragraph}[runin]{\normalfont\itshape}{}{0pt}{}

% Reduce spacing around titles.
\titlespacing*{\section}{0pt}{2\parskip}{0.5\parskip}
\titlespacing*{\subsection}{0pt}{\parskip}{0pt}
\titlespacing*{\subsubsection}{0pt}{\parskip}{2\wordsep}
\titlespacing*{\paragraph}{0pt}{0pt}{2\wordsep}

% Increase space between table rows
\renewcommand{\arraystretch}{1.25}

% URLs should be typeset in the same font as the surrouding text.
\urlstyle{same}

% Dates are separated with -, not /
\renewcommand{\dateseparator}{-}

% A date format for Day Month Year style dates.
\newdateformat{ddmmmyyyydate}{%
    \ifshowdow\dayofweekname{\THEDAY}{\THEMONTH}{\THEYEAR}\fi
    \THEDAY{} \monthname[\THEMONTH{}] \THEYEAR{}%
}

\newcommand{\blankpage}{%
    \newpage%
    \thispagestyle{empty}%
    \mbox{}%
    \newpage%
}

\newcommand{\mychapter}[2]{%
    \newrefsection%
    \chapter{#2}\label{chapter:#2}%
}

\newcommand{\mysection}[2]{%
    \section{#2}\label{section:#1}%
}

\newcommand{\mysubsection}[2]{%
    \subsection{#2}\label{subsection:#1}%
}

\newcommand{\Val}[1]{%
    \text{#1}%
}

\newcommand{\Dots}[1]{%
    \normalfont\multido{}{#1}{â€¢}%
}

\newcommand{\Keyword}[1]{%
    \textbf{#1}%
}

\newcommand{\NoCost}{---}

\NewDocumentCommand{\Pool}{m o}{%
    \( (#1 \IfValueT{#2}{, \text{#2}}) \)%
}

\newcommand{\tldr}[1]{%
    \textbf{#1}%
}

\newcommand{\TBW}{\textit{To be written\ldots}}

\newcommand{\PermanentType}{Permanent}
\newcommand{\ReflexiveType}{Reflexive}
\newcommand{\SimpleType}{Simple}
\newcommand{\SupplementalType}{Supplemental}

\NewDocumentEnvironment{Unavailable}{+b}{%
    \color{gray}%
    #1%
}{}

\makeatletter
\define@cmdkeys{Merit}[Merit@]{
    Description,
    Keywords,
    Rating,
    Reference
}

\NewDocumentEnvironment{Merit}{m m m +b}{%
    \setkeys{Merit}{#2}%
    \protected@edef\Merit@Title{{#1}}%
    \protected@edef\Merit@Label{{merit:#3}}%
    \def\Merit@Body{#4}%
    \expandafter\section\Merit@Title%
    \expandafter\label\Merit@Label%
    \ifdef{\Merit@Description}{%
        \vspace*{-0.25\parskip}%
        \section*{(\Merit@Description)}%
    }{}%
    \textbf{\Merit@Rating}%
    \ifboolexpr{%
        test {\ifdef{\Merit@Keywords}} or%
        test {\ifdef{\Merit@Reference}}%
    }{%
        \vspace{-\parskip}%
        \begin{description}[noitemsep]%
            \ifdef{\Merit@Keywords}{%
                \item[Keywords:] \Merit@Keywords%
            }{}%
            \ifdef{\Merit@Reference}{%
                \item[Reference:] \Merit@Reference%
            }{}%
        \end{description}%
    }{
        \par%
    }%
    \nopagebreak%
    \par%
    \Merit@Body%
}{}
\makeatother

\makeatletter
\define@cmdkeys{Artifact}[Artifact@]{
    Attunement,
    Type,
    Tags,
    HearthstoneSlots,
    Reference
}

\NewDocumentCommand{\Artifact}{m}{%
    \setkeys{Artifact}{#1}%
    \begin{description}[noitemsep]%
        \item[Attunement:] \Artifact@Attunement%
        \item[Type:] \Artifact@Type%
        \ifdef{\Artifact@Tags}{%
            \item[Tags:] \Artifact@Tags%
        }{}%
        \ifdef{\Artifact@HearthstoneSlots}{%
            \item[Hearthstone Slot(s):] \Artifact@HearthstoneSlots%
        }{}%
        \ifdef{\Artifact@Reference}{%
            \item[Reference:] \Artifact@Reference%
        }{}%
    \end{description}%
}
\makeatother

\makeatletter
\define@cmdkeys{Hearthstone}[Hearthstone@]{
    Keywords,
    Type,
    Reference
}

\NewDocumentEnvironment{Hearthstone}{m m +b}{%
    \setkeys{Hearthstone}{#2}%
    \protected@edef\Hearthstone@Name{#1}%
    \protected@edef\Hearthstone@Title{{%
        \Hearthstone@Name{} (\Hearthstone@Type{})%
    }}%
    \def\Hearthstone@Body{#3}%
    \expandafter\subsection\Hearthstone@Title%
    \ifboolexpr{%
        test {\ifdef{\Hearthstone@Keywords}} or%
        test {\ifdef{\Hearthstone@Reference}}%
    }{%
        \vspace*{0.25\parskip}%
        \begin{description}[noitemsep]%
            \ifdef{\Hearthstone@Keywords}{%
                \item[Keywords:] \Hearthstone@Keywords%
            }{}%
            \ifdef{\Hearthstone@Reference}{%
                \item[Reference:] \Hearthstone@Reference%
            }{}%
        \end{description}%
    }{}%
    \nopagebreak%
    \par%
    \Hearthstone@Body%
}{}

\newcommand{\CharmList}{}

\newcommand{\CharmSection}[2]{%
    \mysection{#1}{#2}%
    \CharmGroup{section:#1}%
}

\newcommand{\CharmGroup}[1]{%
    \ifdefempty{\CharmList}{}{%
        \gappto\CharmList{%
            \\%
        }%
    }%
    \gappto\CharmList{%
        \multicolumn{5}{l}{%
            \textbf{\nameref{#1}}%
        } \\%
    }%
}

\makeatletter
\define@cmdkeys{Charm}[Charm@]{
    Cost,
    Duration,
    Keywords,
    Mins,
    Prerequisites,
    Type,
    Reference
}
\define@boolkeys{Charm}[Charm@]{
    Unpurchased
}[true]

\NewDocumentEnvironment{Charm}{m m m +b}{%
    \setkeys{Charm}{Cost=\NoCost, #2}%
    \protected@edef\Charm@Name{#1}%
    \protected@edef\Charm@Title{{%
        \Charm@Name%
        \ifbool{Charm@Unpurchased}{ (Unpurchased)}{}%
    }}%
    \protected@edef\Charm@Label{{charm:#3}}%
    \def\Charm@Description{#4}%
    \def\Charm@Body{%
        \expandafter\subsection\Charm@Title%
        \expandafter\label\Charm@Label%
        \vspace*{0.25\parskip}%
        \begin{description}[noitemsep]%
            \item[Cost:] \Charm@Cost; \textbf{Mins:}~\Charm@Mins%
            \item[Type:] \Charm@Type%
            \ifdef{\Charm@Keywords}{%
                \item[Keywords:] \Charm@Keywords%
            }{}%
            \item[Duration:] \Charm@Duration%
            \ifdef{\Charm@Prerequisites}{%
                \item[Prerequisite Charms:] \Charm@Prerequisites%
            }{}%
            \ifdef{\Charm@Reference}{%
                \item[Reference:] \Charm@Reference%
            }{}%
        \end{description}%
        \nopagebreak%
        \par%
        \Charm@Description%
        \notbool{Charm@Unpurchased}{%
            \xappto\CharmList{%
                \noexpand\nameref\Charm@Label &%
                \expandonce{\Charm@Cost} &%
                \expandonce{\Charm@Type} &%
                \expandonce{\Charm@Duration} &%
                \noexpand\pageref\Charm@Label \noexpand\\%
            }%
        }{}%
    }%
    \ifbool{Charm@Unpurchased}{%
        \begin{Unavailable}%
            \Charm@Body%
        \end{Unavailable}%
    }{%
        \Charm@Body%
    }%
}{}

\makeatother

\newcommand{\ClearCharmList}{%
    \renewcommand{\CharmList}{}%
}

\newcommand{\PrintCharmList}{%
    \begin{longtabu} to \linewidth {lX[L]X[L]X[L]r}%
        \textbf{Name} &%
        \textbf{Cost} &%
        \textbf{Type} &%
        \textbf{Duration} &%
        \textbf{Page} \\%
        \hline%
        \CharmList%
    \end{longtabu}%
    \ClearCharmList%
}

% vim: filetype=tex: textwidth=79:

